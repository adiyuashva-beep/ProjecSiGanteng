<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor SiGanteng - SMAN 1 PEJAGOAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /* --- GAYA TV DISPLAY V7 (FINAL ULTIMATE) --- */
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --neon-blue: #3b82f6;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-gold: #f59e0b;
        }

        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: white; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header {
            height: 10vh; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; padding: 0 40px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .brand { display: flex; flex-direction: column; }
        .brand-row { display: flex; align-items: center; gap: 15px; }
        
        .brand h1 { 
            margin: 0; font-size: 2em; font-weight: 900; 
            background: linear-gradient(to right, #fff, #94a3b8); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        
        /* BADGE SI GANTENG */
        .badge-siganteng {
            background: rgba(59, 130, 246, 0.15);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 2px 12px;
            border-radius: 8px;
            font-size: 0.8em; font-weight: 800; letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-blue);
            animation: pulseGanteng 2s infinite;
        }

        .jam-digital { text-align: right; }
        .waktu { font-size: 2.8em; font-weight: 700; line-height: 1; color: #fff; font-variant-numeric: tabular-nums; }
        .tanggal { font-size: 1em; color: var(--neon-blue); font-weight: 600; text-transform: uppercase; }

        /* KONTEN UTAMA */
        .main-content { flex: 1; display: flex; padding: 20px; gap: 20px; height: 80vh; overflow: hidden; }
        
        /* KARTU UMUM */
        .card-box { background: var(--card-bg); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .card-header { padding: 12px; font-weight: 800; font-size: 1.1em; text-align: center; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* KOLOM 1: GASIK (KIRI) */
        .col-gasik { flex: 1; border-top: 4px solid var(--neon-green); }
        .gasik-header { background: rgba(16, 185, 129, 0.1); color: var(--neon-green); }
        .list-container { flex: 1; overflow-y: auto; padding: 10px; scrollbar-width: none; }
        
        .rank-item { 
            display: flex; align-items: center; padding: 10px; margin-bottom: 6px;
            background: rgba(255,255,255,0.03); border-radius: 10px;
        }
        .rank-num { width: 28px; height: 28px; background: #334155; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-right: 10px; }
        .rank-1 .rank-num { background: var(--neon-gold); color: black; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        .rank-2 .rank-num { background: #cbd5e1; color: black; }
        .rank-3 .rank-num { background: #b45309; color: white; }
        
        .rank-nama { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; }
        .rank-jam { color: var(--neon-green); font-weight: 700; font-family: monospace; font-size: 1em; }

        /* KOLOM 2: TENGAH */
        .col-center { flex: 1.2; display: flex; flex-direction: column; gap: 20px; border: none; }
        
        .stats-wrapper { flex: 1.2; background: var(--card-bg); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); }
        .donut-chart { position: relative; width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(var(--neon-blue) var(--p), #334155 0deg); display: flex; align-items: center; justify-content: center; margin-bottom: 10px; transition: 1s; }
        .donut-inner { width: 85%; height: 85%; background: var(--card-bg); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .big-percent { font-size: 2em; font-weight: 900; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; gap: 5px; text-align: center; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px; }
        .stat-item h4 { margin: 0 0 5px 0; font-size: 0.7em; color: #94a3b8; }
        .stat-item p { margin: 0; font-size: 1.3em; font-weight: 700; }
        .c-hadir { color: var(--neon-green); } .c-izin { color: var(--neon-gold); } .c-alpha { color: var(--neon-red); }

        .live-box { flex: 1; background: var(--card-bg); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; border-top: 4px solid var(--neon-blue); }
        .live-header { padding: 10px; font-size: 0.9em; font-weight: 700; color: var(--neon-blue); border-bottom: 1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;}
        .live-content { flex: 1; padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        
        .live-card { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.5s ease; }
        .live-card.highlight { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); }

        /* KOLOM 3: SPLIT KANAN (TERLAMBAT & BELUM) */
        .col-right-split { flex: 1; display: flex; flex-direction: column; gap: 15px; border:none; overflow: hidden; }
        
        /* BOX ATAS: TERLAMBAT */
        .box-telat { 
            flex: 1; background: var(--card-bg); border-radius: 20px; 
            border: 2px solid rgba(239, 68, 68, 0.5); /* Merah Tegas */
            display: flex; flex-direction: column; overflow: hidden;
        }
        .telat-header { 
            background: rgba(239, 68, 68, 0.15); color: var(--neon-red); padding: 10px; 
            font-weight: 800; font-size: 0.9em; text-align: center; display: flex; justify-content: center; gap:8px;
        }
        
        /* BOX BAWAH: BELUM HADIR */
        .box-belum { 
            flex: 1.5; background: var(--card-bg); border-radius: 20px; 
            border-top: 4px solid #64748b; 
            display: flex; flex-direction: column; overflow: hidden;
        }
        .belum-header { background: rgba(100, 116, 139, 0.1); color: #94a3b8; padding: 10px; font-weight: 700; text-align: center; font-size: 0.9em; }

        .scroller-content { flex: 1; overflow: hidden; padding: 10px; position: relative; }
        .marquee-vertical { display: flex; flex-direction: column; gap: 6px; }
        .anim-scroll { animation: scrollUp 30s linear infinite; }

        .alpha-row { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 10px; border-radius: 6px; background: rgba(255,255,255,0.02);
        }
        .row-telat { background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--neon-red); }
        .row-belum { border-left: 3px solid #64748b; }
        
        .alpha-nama { font-weight: 600; font-size: 0.9em; color: #e2e8f0; }
        .alpha-kelas { font-size: 0.7em; color: #94a3b8; background: rgba(0,0,0,0.2); padding: 1px 5px; border-radius: 4px; }

        /* FOOTER RUNNING TEXT */
        .footer-marquee { height: 6vh; background: #0f172a; display: flex; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 10; }
        marquee { font-size: 1.2em; font-weight: 600; color: #cbd5e1; letter-spacing: 1px; }

        /* ANIMASI */
        @keyframes scrollUp { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulseGanteng { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">
            <div class="brand-row">
                <h1>SMAN 1 PEJAGOAN</h1>
                <span class="badge-siganteng">SI GANTENG</span>
            </div>
            <p id="typing-text" style="min-height: 1.2em; color:#94a3b8; font-weight:600; margin-top:5px;">PUSAT MONITORING KEDISIPLINAN</p>
        </div>
        <div class="jam-digital">
            <div class="waktu" id="jam-real">00:00</div>
            <div class="tanggal" id="tgl-real">...</div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="card-box col-gasik">
            <div class="card-header gasik-header"><i class='bx bxs-trophy'></i> 10 SISWA TER-GASIK</div>
            <div class="list-container" id="gasik-list">
                <p style="text-align:center; padding:20px; opacity:0.5; font-size:0.9em;">Menunggu data...</p>
            </div>
        </div>

        <div class="col-center">
            <div class="stats-wrapper">
                <div class="donut-chart" id="chart-absen" style="--p: 0deg;">
                    <div class="donut-inner">
                        <span class="big-percent" id="persen-text">0%</span>
                    </div>
                </div>
                <div class="stat-grid">
                    <div class="stat-item"><h4 class="c-hadir">HADIR</h4><p id="total-hadir">0</p></div>
                    <div class="stat-item"><h4 class="c-izin">IZIN</h4><p id="total-izin">0</p></div>
                    <div class="stat-item"><h4 class="c-alpha">BELUM</h4><p id="total-alpha">0</p></div>
                </div>
            </div>

            <div class="live-box">
                <div class="live-header"><i class='bx bx-radar'></i> BARU SAJA MASUK</div>
                <div id="live-container" class="live-content"></div>
            </div>
        </div>

        <div class="col-right-split">
            
            <div class="box-telat">
                <div class="telat-header">
                    <i class='bx bxs-alarm-exclamation'></i> TERLAMBAT (LEBIH DARI 06.45)
                </div>
                <div class="scroller-content">
                    <div class="marquee-vertical" id="list-telat">
                        <div style="text-align:center; padding:20px; color:#94a3b8; font-size:0.8em; font-style:italic;">
                            Nihil (Semua Tepat Waktu)
                        </div>
                    </div>
                </div>
            </div>

            <div class="box-belum">
                <div class="belum-header"><i class='bx bx-user-x'></i> BELUM HADIR</div>
                <div class="scroller-content">
                    <div class="marquee-vertical" id="list-belum">
                        </div>
                </div>
            </div>

        </div>
    </div>

    <div class="footer-marquee">
        <marquee scrollamount="10">
            ðŸ“¢ INFO: INI ADALAH UJI COBA SISTEM ABSENSI DIGITAL (SI GANTENG) ðŸš€ MARI BERSIAP MEMASUKI DUNIA PENDIDIKAN BERBASIS DIGITAL ðŸ’» DISIPLIN ADALAH KUNCI MENYAMBUT SEKOLAH YANG PENUH SEMANGAT! ðŸ”¥ JANGAN LUPA SENYUM HARI INI ðŸ˜Š
        </marquee>
    </div>

    <script src="./assets/js/data_sekolah.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./assets/js/firebase_config.js"></script>

    <script>
    // === CONFIG ===
    const JAM_BATAS_TERLAMBAT = "06:45"; 

    // === 1. SETUP WAKTU (FIX LOCAL TIME) ===
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`; // Format YYYY-MM-DD sesuai waktu lokal
    
    console.log("Monitor aktif untuk tanggal:", today);

    const dbRef = firebase.database().ref(`absensi/${today}`);
    
    // Ambil Total Siswa
    let totalSiswa = 0;
    if(typeof dataSiswa !== 'undefined' && dataSiswa.length > 0) {
        totalSiswa = dataSiswa.length;
    } else {
        totalSiswa = 1080; // Dummy
    }

    // Jam Realtime
    setInterval(() => {
        const now = new Date();
        document.getElementById('jam-real').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('tgl-real').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
    }, 1000);

    // === 2. FIREBASE LISTENER ===
    let dataAbsen = {}; 
    dbRef.on('value', snap => {
        dataAbsen = snap.val() || {};
        updateDashboard(); 
    });

    dbRef.on('child_added', snap => {
        const val = snap.val();
        if(val.status === 'Hadir' || val.status === 'Izin') addToFeed(val);
    });

    // === 3. LOGIKA CERDAS SI GANTENG ===
    function updateDashboard() {
        const listSemuaHadir = Object.values(dataAbsen).filter(d => d.status === 'Hadir');
        
        // --- FILTER 1: SIAPA YANG TERLAMBAT? ---
        const listTerlambat = listSemuaHadir.filter(d => d.jam_masuk > JAM_BATAS_TERLAMBAT);
        
        // --- FILTER 2: SIAPA YANG GASIK? ---
        const listGasik = [...listSemuaHadir].sort((a,b) => a.jam_masuk.localeCompare(b.jam_masuk));
        
        // --- FILTER 3: SIAPA YANG BELUM HADIR? ---
        let listBelumHadir = [];
        if(typeof dataSiswa !== 'undefined') {
            const yangSudahAbsen = Object.keys(dataAbsen);
            listBelumHadir = dataSiswa.filter(s => !yangSudahAbsen.includes(s.username));
            listBelumHadir.sort((a,b) => a.kelas.localeCompare(b.kelas)); 
        }

        // --- RENDER SEMUA ---
        renderGasik(listGasik.slice(0, 10)); // Top 10
        renderList(listTerlambat, 'list-telat', 'telat'); 
        renderList(listBelumHadir, 'list-belum', 'belum'); 

        // --- UPDATE STATISTIK ---
        const hadirCount = listSemuaHadir.length;
        const izinCount = Object.values(dataAbsen).filter(d => d.status === 'Izin').length;
        let alphaCount = totalSiswa - (hadirCount + izinCount);
        if(alphaCount < 0) alphaCount = 0;

        document.getElementById('total-hadir').innerText = hadirCount;
        document.getElementById('total-izin').innerText = izinCount;
        document.getElementById('total-alpha').innerText = alphaCount;

        let persen = (totalSiswa > 0) ? (hadirCount / totalSiswa) * 100 : 0;
        let textShow = (persen === 0) ? "0%" : (persen < 1 ? persen.toFixed(1) + "%" : Math.round(persen) + "%");
        document.getElementById('persen-text').innerText = textShow;
        
        let derajat = persen * 3.6;
        if(hadirCount > 0 && derajat < 10) derajat = 10; 
        document.getElementById('chart-absen').style.setProperty('--p', `${derajat}deg`);
    }

    // --- FUNGSI RENDER UMUM ---
    function renderList(data, containerId, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; 
        
        if(data.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:15px; color:#64748b; font-size:0.8em;">${type === 'telat' ? 'Nihil (Semua Tepat Waktu)' : 'Semua Hadir!'}</div>`;
            return;
        }

        if(data.length > 5) {
            container.classList.add('anim-scroll');
            container.style.animationDuration = `${data.length * 3}s`; 
        } else {
            container.classList.remove('anim-scroll');
        }

        data.forEach(s => {
            const rowClass = type === 'telat' ? 'row-telat' : 'row-belum';
            const jamInfo = type === 'telat' ? `<span style="font-weight:700; color:#ef4444;">${s.jam_masuk}</span>` : '';
            
            const html = `
                <div class="alpha-row ${rowClass}">
                    <div style="flex:1;">
                        <div class="alpha-nama" style="${type==='telat' ? 'color:#fca5a5' : ''}">${s.nama}</div>
                        <div class="alpha-kelas">${s.kelas}</div>
                    </div>
                    <div style="font-size:0.8em;">${jamInfo}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderGasik(data) {
        const container = document.getElementById('gasik-list');
        container.innerHTML = '';
        if(data.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Belum ada data.</p>';
            return;
        }
        data.forEach((d, i) => {
            let rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : ''));
            const html = `
                <div class="rank-item ${rankClass}">
                    <div class="rank-num">${i+1}</div>
                    <div class="rank-nama">${d.nama}<br><span style="font-size:0.7em; opacity:0.7; font-weight:normal;">${d.kelas}</span></div>
                    <div class="rank-jam">${d.jam_masuk}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function addToFeed(d) {
        const container = document.getElementById('live-container');
        const icon = d.status === 'Hadir' ? "<i class='bx bxs-user-check'></i>" : "<i class='bx bxs-envelope'></i>";
        const color = d.status === 'Hadir' ? 'var(--neon-green)' : 'var(--neon-gold)';
        const html = `
            <div class="live-card highlight">
                <div class="avatar" style="color:${color}; background:rgba(255,255,255,0.1);">${icon}</div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:0.9em;">${d.nama}</div>
                    <div style="font-size:0.7em; opacity:0.7;">${d.kelas}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:800; color:${color}; font-size:0.9em;">${d.jam_masuk}</div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', html);
        if(container.children.length > 5) container.lastElementChild.remove();
        setTimeout(() => { if(container.firstElementChild) container.firstElementChild.classList.remove('highlight'); }, 800);
    }
    
    // === 4. TYPING EFFECT (FILOSOFI) ===
    const texts = [
        "PUSAT MONITORING KEDISIPLINAN SISWA", 
        "FILOSOFI SI GANTENG:",
        "SISTEM INFORMASI GERAKAN ABSENSI NYATA, TERPADU, EFISIEN, NYAMAN & GESIT",
        "BERSAMA MEWUJUDKAN GENERASI SMAN 1 PEJAGOAN YANG DISIPLIN & BERKARAKTER"
    ];

    let count = 0; let index = 0; let currentText = ""; let letter = ""; let isDeleting = false; let delay = 100;

    function type() {
        if (count === texts.length) count = 0;
        currentText = texts[count];

        if (isDeleting) {
            letter = currentText.slice(0, --index);
            delay = 30;
        } else {
            letter = currentText.slice(0, ++index);
            delay = 80;
        }

        const target = document.getElementById("typing-text");
        if(target) {
            target.innerHTML = letter + '<span style="border-right: 3px solid var(--neon-blue); animation: blink 0.7s infinite; margin-left:2px;">&nbsp;</span>';
        }

        if (!isDeleting && letter.length === currentText.length) {
            delay = 2000; isDeleting = true;
        } else if (isDeleting && letter.length === 0) {
            isDeleting = false; count++; delay = 500;
        }
        setTimeout(type, delay);
    }
    document.addEventListener("DOMContentLoaded", type);
    </script>
</body>
</html>