<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Disiplin - SMAN 1 PEJAGOAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GAYA TV DISPLAY V4 (DISIPLIN MAX) --- */
        body { margin: 0; font-family: 'Outfit', sans-serif; background: #0f172a; color: white; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header {
            height: 10vh; background: #1e293b; 
            display: flex; justify-content: space-between; align-items: center; padding: 0 40px;
            border-bottom: 4px solid #3b82f6;
        }
        .brand h1 { margin: 0; font-size: 2em; font-weight: 900; background: -webkit-linear-gradient(#38bdf8, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand p { margin: 0; font-size: 1em; color: #94a3b8; letter-spacing: 3px; text-transform: uppercase; }
        
        .jam-digital { text-align: right; }
        .waktu { font-size: 3em; font-weight: 700; line-height: 1; color: #fff; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .tanggal { font-size: 1em; color: #94a3b8; font-weight: 300; }

        /* KONTEN UTAMA (3 KOLOM) */
        .main-content { flex: 1; display: flex; padding: 20px; gap: 20px; height: 80vh; overflow: hidden; }
        
        /* GENERAL CARD STYLE */
        .card-box { background: #1e293b; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .card-header { padding: 15px; font-weight: 700; font-size: 1.2em; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
        
        /* KOLOM 1: TOP 10 GASIK (APRESIASI) */
        .col-gasik { flex: 1; border-top: 5px solid #10b981; }
        .gasik-header { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .list-container { flex: 1; overflow-y: auto; padding: 0 10px; }
        
        .rank-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 30px; height: 30px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px; font-size: 0.9em; }
        .rank-1 .rank-num { background: #f59e0b; color: black; } /* Emas */
        .rank-2 .rank-num { background: #cbd5e1; color: black; } /* Perak */
        .rank-3 .rank-num { background: #b45309; color: white; } /* Perunggu */
        .rank-nama { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-jam { color: #10b981; font-weight: 700; font-family: monospace; font-size: 1.1em; }

        /* KOLOM 2: TENGAH (LIVE FEED & STATS) */
        .col-center { flex: 1.2; display: flex; flex-direction: column; gap: 20px; background: transparent; border: none; }
        
        /* Chart & Stats */
        .stats-wrapper { flex: 1; background: #1e293b; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .donut-chart { position: relative; width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(#3b82f6 var(--p), #334155 0deg); display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .donut-inner { width: 80%; height: 80%; background: #1e293b; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .big-percent { font-size: 2.5em; font-weight: 800; color: white; line-height: 1; }
        .label-percent { font-size: 0.8em; color: #94a3b8; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; gap: 10px; text-align: center; }
        .stat-item h4 { margin: 0; font-size: 0.8em; color: #94a3b8; font-weight: 400; }
        .stat-item p { margin: 0; font-size: 1.5em; font-weight: 700; }
        .c-hadir { color: #10b981; } .c-izin { color: #f59e0b; } .c-alpha { color: #ef4444; }

        /* Live Feed Box */
        .live-box { flex: 1; background: #1e293b; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; overflow: hidden; border-top: 4px solid #3b82f6; }
        .live-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; animation: slideIn 0.5s ease; }
        .live-card.highlight { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
        .avatar { width: 50px; height: 50px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; }
        
        /* KOLOM 3: BELUM ABSEN (SANKSI SOSIAL) */
        .col-alpha { flex: 1; border-top: 5px solid #ef4444; }
        .alpha-header { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .alpha-scroller { flex: 1; overflow: hidden; position: relative; padding: 10px; }
        /* Animasi Scrolling Otomatis */
        .marquee-content { display: flex; flex-direction: column; gap: 8px; animation: scrollUp 20s linear infinite; }
        .alpha-row { font-size: 1.1em; color: #ef4444; padding: 8px; border-bottom: 1px dashed rgba(239, 68, 68, 0.3); display: flex; justify-content: space-between; }
        .alpha-row span { color: #94a3b8; font-size: 0.8em; }

        /* FOOTER */
        .footer-marquee { height: 6vh; background: #1e293b; display: flex; align-items: center; border-top: 1px solid #334155; }
        marquee { font-size: 1.2em; font-weight: 600; color: #cbd5e1; letter-spacing: 1px; }

        @keyframes scrollUp { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">
            <h1>SMAN 1 PEJAGOAN</h1>
            <p>PUSAT MONITORING KEDISIPLINAN</p>
        </div>
        <div class="jam-digital">
            <div class="waktu" id="jam-real">00:00</div>
            <div class="tanggal" id="tgl-real">...</div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="card-box col-gasik">
            <div class="card-header gasik-header">üèÜ 10 SISWA TER-GASIK</div>
            <div class="list-container" id="gasik-list">
                <p style="text-align:center; padding:20px; opacity:0.5;">Menunggu data...</p>
            </div>
        </div>

        <div class="col-center">
            <div class="stats-wrapper">
                <div class="donut-chart" id="chart-absen" style="--p: 0deg;">
                    <div class="donut-inner">
                        <span class="big-percent" id="persen-text">0%</span>
                        <span class="label-percent">KEHADIRAN</span>
                    </div>
                </div>
                <div class="stat-grid">
                    <div class="stat-item"><h4 class="c-hadir">HADIR</h4><p id="total-hadir">0</p></div>
                    <div class="stat-item"><h4 class="c-izin">IZIN</h4><p id="total-izin">0</p></div>
                    <div class="stat-item"><h4 class="c-alpha">BELUM</h4><p id="total-alpha">0</p></div>
                </div>
            </div>

            <div class="live-box">
                <div class="card-header" style="font-size:1em; padding:10px; color:#38bdf8; border-bottom:1px solid rgba(255,255,255,0.1);">BARU SAJA MASUK</div>
                <div id="live-container" style="flex:1; overflow:hidden;">
                    </div>
            </div>
        </div>

        <div class="card-box col-alpha">
            <div class="card-header alpha-header">‚ö†Ô∏è BELUM HADIR</div>
            <div class="alpha-scroller">
                <div class="marquee-content" id="alpha-list">
                    </div>
            </div>
        </div>

    </div>

    <div class="footer-marquee">
        <marquee scrollamount="10">
            üì¢ INFO: INI ADALAH UJI COBA SISTEM ABSENSI DIGITAL (SI GANTENG) üöÄ MARI BERSIAP MEMASUKI DUNIA PENDIDIKAN BERBASIS DIGITAL üíª DISIPLIN ADALAH KUNCI MENYAMBUT SEKOLAH YANG PENUH SEMANGAT! üî• JANGAN LUPA SENYUM HARI INI üòä
        </marquee>
    </div>

    <script src="./assets/js/data_sekolah.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./assets/js/firebase_config.js"></script>

    <script>
    // === 1. SETUP ===
    const today = new Date().toISOString().split('T')[0];
    const dbRef = firebase.database().ref(`absensi/${today}`);
    
    // Hitung Total Siswa dari data_sekolah.js
    let totalSiswa = 0;
    if(typeof dataSiswa !== 'undefined' && dataSiswa.length > 0) {
        totalSiswa = dataSiswa.length;
    } else {
        // Fallback kalau data belum load, pakai angka dummy biar ga error
        totalSiswa = 100; 
    }

    // Jam Realtime
    setInterval(() => {
        const now = new Date();
        document.getElementById('jam-real').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('tgl-real').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
    }, 1000);

    // === 2. FIREBASE LISTENER ===
    let dataAbsen = {}; 

    dbRef.on('value', snap => {
        dataAbsen = snap.val() || {};
        updateDashboard();
    });

    // Animasi Live Feed
    dbRef.on('child_added', snap => {
        const val = snap.val();
        if(val.status === 'Hadir' || val.status === 'Izin') {
            addToFeed(val);
        }
    });

    // === 3. LOGIKA UPDATE UTAMA ===
    function updateDashboard() {
        // A. UPDATE TOP 10 GASIK
        const listHadir = Object.values(dataAbsen).filter(d => d.status === 'Hadir');
        listHadir.sort((a,b) => a.jam_masuk.localeCompare(b.jam_masuk));
        
        const top10 = listHadir.slice(0, 10);
        renderGasik(top10);

        // B. UPDATE STATISTIK & DONAT (DENGAN VISUAL HACK)
        const hadirCount = listHadir.length;
        const izinCount = Object.values(dataAbsen).filter(d => d.status === 'Izin').length;
        
        let alphaCount = totalSiswa - (hadirCount + izinCount);
        if(alphaCount < 0) alphaCount = 0;
        
        document.getElementById('total-hadir').innerText = hadirCount;
        document.getElementById('total-izin').innerText = izinCount;
        document.getElementById('total-alpha').innerText = alphaCount;

        // --- RUMUS DONAT BARU ---
        let persen = 0;
        if (totalSiswa > 0) {
            persen = (hadirCount / totalSiswa) * 100;
        }

        // 1. LOGIKA TEKS: Tampilkan desimal jika kecil (misal 0.3%)
        let textToShow = "0%";
        if (persen === 0) {
            textToShow = "0%";
        } else if (persen < 1) {
            textToShow = persen.toFixed(1) + "%"; // Tampil "0.3%"
        } else {
            textToShow = Math.round(persen) + "%"; // Tampil "15%"
        }
        document.getElementById('persen-text').innerText = textToShow;
        
        // 2. LOGIKA GRAFIK: Paksa nongol minimal 5 derajat jika ada yang hadir
        let derajat = persen * 3.6; // Rumus asli
        if (hadirCount > 0 && derajat < 10) {
            derajat = 10; // VISUAL HACK: Paksa jadi 10 derajat biar kelihatan mata
        }
        
        document.getElementById('chart-absen').style.setProperty('--p', `${derajat}deg`);


        // C. UPDATE DAFTAR BELUM HADIR
        if(typeof dataSiswa !== 'undefined') {
            const yangSudahAbsen = Object.keys(dataAbsen);
            const listAlpha = dataSiswa.filter(s => !yangSudahAbsen.includes(s.username));
            listAlpha.sort((a,b) => a.kelas.localeCompare(b.kelas));
            renderAlpha(listAlpha);
        }
    }

    // === 4. RENDER UI COMPONENTS ===
    function renderGasik(data) {
        const container = document.getElementById('gasik-list');
        container.innerHTML = '';
        
        if(data.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Belum ada yang hadir.</p>';
            return;
        }

        data.forEach((d, i) => {
            let rankClass = '';
            if(i===0) rankClass = 'rank-1';
            else if(i===1) rankClass = 'rank-2';
            else if(i===2) rankClass = 'rank-3';

            container.innerHTML += `
                <div class="rank-item ${rankClass}">
                    <div class="rank-num">${i+1}</div>
                    <div class="rank-nama">
                        ${d.nama} <br>
                        <span style="font-size:0.7em; opacity:0.7; font-weight:normal;">${d.kelas}</span>
                    </div>
                    <div class="rank-jam">${d.jam_masuk}</div>
                </div>
            `;
        });
    }

    function renderAlpha(data) {
        const container = document.getElementById('alpha-list');
        container.innerHTML = '';

        if(data.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#10b981;">NIHIL (SEMUA HADIR)</div>';
            return;
        }

        if(data.length < 10) {
            container.style.animation = 'none';
        } else {
                container.style.animation = `scrollUp ${data.length * 2}s linear infinite`; 
        }

        data.forEach(s => {
            container.innerHTML += `
                <div class="alpha-row">
                    <strong>${s.nama}</strong>
                    <span>${s.kelas}</span>
                </div>
            `;
        });
    }

    function addToFeed(d) {
        const container = document.getElementById('live-container');
        const statusColor = d.status === 'Hadir' ? '#10b981' : '#f59e0b';
        const icon = d.status === 'Hadir' ? 'üéì' : 'üì©';
        
        const html = `
            <div class="live-card highlight">
                <div class="avatar">${icon}</div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:1.1em;">${d.nama}</div>
                    <div style="font-size:0.8em; opacity:0.7;">${d.kelas}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:800; color:${statusColor}; font-size:1.2em;">${d.jam_masuk}</div>
                    <div style="font-size:0.7em; font-weight:700; color:${statusColor};">${d.status.toUpperCase()}</div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('afterbegin', html);
        
        if(container.children.length > 3) container.lastElementChild.remove();

        setTimeout(() => {
            if(container.firstElementChild) container.firstElementChild.classList.remove('highlight');
        }, 1000);
    }
</script>
</body>
</html>