<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin & BK - SiGanteng</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* 1. RESET & LAYOUT */
        body { margin: 0; font-family: 'Outfit', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; color: #1e293b; }
        
        /* 2. SIDEBAR */
        .sidebar { width: 260px; background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); color: white; display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; }
        .logo { font-size: 24px; font-weight: 800; color: #38bdf8; margin-bottom: 40px; border-bottom: 1px solid #334155; padding-bottom: 20px; text-align: center; letter-spacing: 1px; }
        .menu-item { text-decoration: none; color: #94a3b8; padding: 15px; margin-bottom: 8px; border-radius: 12px; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .menu-item:hover, .menu-item.aktif { background-color: rgba(255,255,255,0.1); color: white; }
        .menu-logout { margin-top: auto; color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        /* 3. KONTEN UTAMA */
        .konten-utama { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .header-atas { background: white; padding: 20px 30px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        
        /* VIEW 1: DASHBOARD HARIAN (GRID) */
        #view-harian { display: block; }
        .grid-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card-stat { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-bottom: 4px solid #e2e8f0; }
        .stat-hijau { border-color: #10b981; } .stat-merah { border-color: #ef4444; } .stat-kuning { border-color: #f59e0b; }
        .angka { font-size: 32px; font-weight: 800; color: #0f172a; margin: 5px 0 0; }
        
        .grid-kelas { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card-kelas { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; border: 1px solid #f1f5f9; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card-kelas:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #3b82f6; }

        /* VIEW 2: REKAP BULANAN (TABEL BESAR) */
        #view-rekap { display: none; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); flex: 1; overflow: hidden; flex-direction: column; }
        
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; }
        select { padding: 10px 15px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: inherit; font-weight: 600; color: #334155; cursor: pointer; }
        .btn-cari { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; }
        .btn-download { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; margin-left: auto; }

        /* TABEL SCROLLABLE */
        .table-wrapper { flex: 1; overflow: auto; border: 1px solid #e2e8f0; border-radius: 10px; position: relative; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; min-width: 1500px; /* Biar scroll muncul */ }
        
        th, td { padding: 8px; text-align: center; border: 1px solid #e2e8f0; white-space: nowrap; }
        th { background: #f1f5f9; color: #475569; font-weight: 700; position: sticky; top: 0; z-index: 10; height: 30px;}
        
        /* Sticky Kolom Nama (Biar nama tetep kelihatan pas discroll ke tanggal 31) */
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid #e2e8f0; min-width: 150px; text-align: left; padding-left: 15px; }
        th:nth-child(2) { background: #f1f5f9; z-index: 11; }

        /* Warna Status Tabel */
        .sel-hadir { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .sel-izin { background-color: #fef3c7; color: #b45309; font-weight: bold; }
        .sel-alpha { background-color: #fee2e2; color: #991b1b; }
        .sel-libur { background-color: #e2e8f0; color: #94a3b8; }

        /* DETAIL HARIAN (POPUP) */
        .modal-detail { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index: 999; }
        .box-detail { background:white; padding:30px; border-radius:20px; width:90%; max-width:800px; max-height:80vh; overflow-y:auto; }
        
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">üöÄ SiGanteng</div>
        
        <div class="menu-item aktif" id="menu-harian" onclick="gantiMenu('harian')">
            <span>üìä</span> Dashboard Harian
        </div>
        
        <div class="menu-item" id="menu-rekap" onclick="gantiMenu('rekap')">
            <span>üìÖ</span> Rekap Bulanan (BK)
        </div>

        <div class="menu-item menu-logout" onclick="logout()">
            <span>üö™</span> Keluar Admin
        </div>
    </div>

    <div class="konten-utama">
        <div class="header-atas">
            <div>
                <h2 style="margin:0; font-weight:800;" id="judul-halaman">Dashboard Harian</h2>
                <p style="margin:5px 0 0; color:#64748b; font-size:14px;" id="sub-judul">Pantauan Realtime Hari Ini</p>
            </div>
            <div style="font-weight:700; color:#0f172a;" id="jam-real">00:00:00</div>
        </div>

        <div id="view-harian">
            <div class="grid-stats">
                <div class="card-stat stat-hijau">
                    <span style="font-size:12px; color:#64748b; font-weight:700;">TOTAL HADIR</span>
                    <p class="angka" id="stat-hadir">0</p>
                </div>
                <div class="card-stat stat-kuning">
                    <span style="font-size:12px; color:#64748b; font-weight:700;">IZIN / SAKIT</span>
                    <p class="angka" id="stat-izin">0</p>
                </div>
                <div class="card-stat stat-merah">
                    <span style="font-size:12px; color:#64748b; font-weight:700;">BELUM ABSEN</span>
                    <p class="angka" id="stat-alpha">0</p>
                </div>
                <div class="card-stat">
                    <span style="font-size:12px; color:#64748b; font-weight:700;">TOTAL SISWA</span>
                    <p class="angka" id="stat-total">0</p>
                </div>
            </div>

            <h3 style="color:#475569; margin-bottom:15px;">üìÇ Pilih Kelas untuk Detail:</h3>
            <div class="grid-kelas" id="grid-kelas-container">
                <p>Memuat data kelas...</p>
            </div>
        </div>

        <div id="view-rekap">
            <div class="filter-bar">
                <select id="pilih-bulan"></select>
                <select id="pilih-tahun"></select>
                <select id="pilih-kelas-rekap">
                    <option value="">-- Pilih Kelas --</option>
                </select>
                <button class="btn-cari" onclick="loadRekapBulanan()">üîç Tampilkan Data</button>
                <button class="btn-download" onclick="downloadExcelRekap()">üì• Download Excel BK</button>
            </div>

            <div class="table-wrapper">
                <table id="tabel-rekap">
                    <thead>
                        <tr id="header-row">
                            </tr>
                    </thead>
                    <tbody id="body-rekap">
                        <tr><td colspan="35" style="padding:30px;">Silakan pilih Bulan & Kelas lalu klik Tampilkan.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal-detail" id="modal-detail">
            <div class="box-detail">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="margin:0;" id="judul-modal">Detail Kelas</h2>
                    <button onclick="tutupModal()" style="background:#ef4444; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">Tutup</button>
                </div>
                <table style="min-width:100%;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th>No</th><th>Nama Siswa</th><th>Status</th><th>Jam Masuk</th><th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="body-detail-harian"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script src="./assets/js/data_sekolah.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./assets/js/firebase_config.js"></script>

    <script>
        // === 1. INISIALISASI & NAVIGASI ===
        const today = new Date();
        
        // Setup Jam Realtime
        setInterval(() => {
            document.getElementById('jam-real').innerText = new Date().toLocaleTimeString('id-ID');
        }, 1000);

        // Populate Dropdown Bulan & Tahun
        const bulanNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const selBulan = document.getElementById('pilih-bulan');
        bulanNames.forEach((b, i) => {
            let opt = document.createElement('option');
            opt.value = i; 
            opt.text = b;
            if(i === today.getMonth()) opt.selected = true;
            selBulan.appendChild(opt);
        });
        
        const selTahun = document.getElementById('pilih-tahun');
        const thnSkrg = today.getFullYear();
        for(let t = thnSkrg; t >= thnSkrg-1; t--) {
            let opt = document.createElement('option');
            opt.value = t; opt.text = t;
            selTahun.appendChild(opt);
        }

        // Ambil Daftar Kelas dari data_sekolah.js
        let listKelas = [];
        let kelompokKelas = {};
        
        if(typeof dataSiswa !== 'undefined'){
            // Grouping Data
            dataSiswa.forEach(s => {
                if(!kelompokKelas[s.kelas]) kelompokKelas[s.kelas] = [];
                kelompokKelas[s.kelas].push(s);
            });
            listKelas = Object.keys(kelompokKelas).sort();

            // Isi Dropdown Rekap
            const selKelasRekap = document.getElementById('pilih-kelas-rekap');
            listKelas.forEach(k => {
                selKelasRekap.innerHTML += `<option value="${k}">${k}</option>`;
            });
        } else { alert("File data_sekolah.js tidak ditemukan!"); }

        function gantiMenu(menu) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('aktif'));
            document.getElementById('view-harian').style.display = 'none';
            document.getElementById('view-rekap').style.display = 'none';

            if(menu === 'harian') {
                document.getElementById('menu-harian').classList.add('aktif');
                document.getElementById('view-harian').style.display = 'block';
                document.getElementById('judul-halaman').innerText = "Dashboard Harian";
                document.getElementById('sub-judul').innerText = "Pantauan Realtime Hari Ini";
                loadDataHarian(); // Refresh data harian
            } else {
                document.getElementById('menu-rekap').classList.add('aktif');
                document.getElementById('view-rekap').style.display = 'flex'; // Flex biar full height
                document.getElementById('judul-halaman').innerText = "Rekapitulasi Bulanan";
                document.getElementById('sub-judul').innerText = "Laporan Absensi Untuk BK & Wali Kelas";
            }
        }

        // === 2. LOGIKA DASHBOARD HARIAN (GRID) ===
        function loadDataHarian() {
            const tglStr = new Date().toISOString().split('T')[0];
            
            database.ref(`absensi/${tglStr}`).on('value', snap => {
                const dataAbsen = snap.val() || {};
                
                let totHadir = 0, totIzin = 0;
                Object.values(dataAbsen).forEach(d => {
                    if(d.status === 'Hadir') totHadir++;
                    if(d.status === 'Izin') totIzin++;
                });

                document.getElementById('stat-hadir').innerText = totHadir;
                document.getElementById('stat-izin').innerText = totIzin;
                document.getElementById('stat-total').innerText = dataSiswa.length;
                document.getElementById('stat-alpha').innerText = dataSiswa.length - (totHadir + totIzin);

                // Render Grid Kelas
                const container = document.getElementById('grid-kelas-container');
                container.innerHTML = '';

                listKelas.forEach(kls => {
                    // Hitung per kelas
                    let hadirKls = 0;
                    kelompokKelas[kls].forEach(s => {
                        if(dataAbsen[s.username]) hadirKls++;
                    });

                    container.innerHTML += `
                        <div class="card-kelas" onclick="bukaModalHarian('${kls}')">
                            <h3 style="margin:0; font-size:18px;">${kls}</h3>
                            <p style="margin:5px 0; font-size:12px; color:#64748b;">${kelompokKelas[kls].length} Siswa</p>
                            <div style="margin-top:10px; font-weight:bold; color:#10b981;">${hadirKls} Data Masuk</div>
                        </div>
                    `;
                });
            });
        }

        function bukaModalHarian(kelas) {
            document.getElementById('modal-detail').style.display = 'flex';
            document.getElementById('judul-modal').innerText = `Detail Harian - ${kelas}`;
            
            const tglStr = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('body-detail-harian');
            tbody.innerHTML = '<tr><td colspan="5">Memuat...</td></tr>';

            database.ref(`absensi/${tglStr}`).once('value').then(snap => {
                const dataAbsen = snap.val() || {};
                tbody.innerHTML = '';
                
                // Sortir Nama
                const siswaUrut = kelompokKelas[kelas].sort((a,b) => a.nama.localeCompare(b.nama));

                siswaUrut.forEach((s, i) => {
                    const absen = dataAbsen[s.username];
                    let st = '<span style="color:red">Alpha</span>';
                    let jam = '-';
                    let ket = '-';

                    if(absen) {
                        if(absen.status === 'Hadir') {
                            st = '<span style="color:green; font-weight:bold;">Hadir</span>';
                            jam = absen.jam_masuk;
                            ket = "Tepat Waktu";
                        } else {
                            st = '<span style="color:#b45309; font-weight:bold;">Izin</span>';
                            ket = absen.keterangan || "-";
                        }
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${i+1}</td>
                            <td style="text-align:left;">${s.nama}</td>
                            <td>${st}</td>
                            <td>${jam}</td>
                            <td>${ket}</td>
                        </tr>
                    `;
                });
            });
        }
        function tutupModal() { document.getElementById('modal-detail').style.display = 'none'; }


        // === 3. LOGIKA REKAP BULANAN (THE BEAST) ===
        async function loadRekapBulanan() {
            const bln = parseInt(document.getElementById('pilih-bulan').value);
            const thn = document.getElementById('pilih-tahun').value;
            const kls = document.getElementById('pilih-kelas-rekap').value;

            if(!kls) { alert("Pilih kelas dulu Ndan!"); return; }

            const tbody = document.getElementById('body-rekap');
            const thead = document.getElementById('header-row');
            tbody.innerHTML = '<tr><td colspan="35">‚è≥ Sedang menarik data sebulan... Mohon tunggu sebentar...</td></tr>';

            // 1. GENERATE HEADER TANGGAL (1-31)
            const jmlHari = new Date(thn, bln + 1, 0).getDate(); // Cek jumlah hari bulan itu
            let htmlHead = `<th>No</th><th>Nama Siswa</th>`;
            for(let d=1; d<=jmlHari; d++) {
                htmlHead += `<th>${d}</th>`;
            }
            htmlHead += `<th style="background:#dcfce7">H</th><th style="background:#fef3c7">I</th><th style="background:#fee2e2">A</th>`;
            thead.innerHTML = htmlHead;

            // 2. TARIK DATA FIREBASE (Range Query)
            // Format YYYY-MM
            const blnStr = (bln+1).toString().padStart(2, '0');
            const startKey = `${thn}-${blnStr}-01`;
            const endKey = `${thn}-${blnStr}-31`;

            // Kita tarik data range tanggal
            // Karena struktur Firebase kita `absensi/YYYY-MM-DD`, kita harus tarik per tanggal atau parentnya
            // Agar efisien, kita tarik root `absensi` lalu filter key-nya di client (untuk skala sekolah masih ringan)
            // Atau loop request (tapi lambat). Cara terbaik: OrderByKey
            
            const snap = await database.ref('absensi').orderByKey().startAt(startKey).endAt(endKey).once('value');
            const rawData = snap.val() || {}; // Isinya: { "2025-12-01": {...}, "2025-12-02": {...} }

            // 3. OLAH DATA KE TABEL
            let htmlBody = '';
            const siswaUrut = kelompokKelas[kls].sort((a,b) => a.nama.localeCompare(b.nama));

            siswaUrut.forEach((s, i) => {
                let rowHtml = `<td>${i+1}</td><td style="text-align:left; font-weight:600;">${s.nama}</td>`;
                
                let totH = 0, totI = 0, totA = 0;

                // Loop Tanggal 1 s.d Akhir Bulan
                for(let d=1; d<=jmlHari; d++) {
                    const tglCek = `${thn}-${blnStr}-${d.toString().padStart(2, '0')}`;
                    const dataHariIni = rawData[tglCek]; // Data satu sekolah hari itu
                    
                    let selContent = '-';
                    let cls = '';

                    if(dataHariIni && dataHariIni[s.username]) {
                        const absenSiswa = dataHariIni[s.username];
                        if(absenSiswa.status === 'Hadir') {
                            selContent = absenSiswa.jam_masuk.substring(0,5); // Ambil jam:menit
                            cls = 'sel-hadir';
                            totH++;
                        } else {
                            selContent = 'IZIN';
                            cls = 'sel-izin';
                            totI++;
                        }
                    } else {
                        // Cek hari libur (Sabtu/Minggu) biar gak merah semua
                        const dateObj = new Date(tglCek);
                        const dayNum = dateObj.getDay();
                        if(dayNum === 0 || dayNum === 6) { 
                            selContent = ''; cls = 'sel-libur'; 
                        } else {
                            // Cek apakah tanggal itu sudah lewat atau belum?
                            if(new Date(tglCek) <= today) {
                                selContent = ''; cls = 'sel-alpha'; totA++; // Alpha cuma dihitung kalau tanggalnya sudah lewat
                            }
                        }
                    }
                    rowHtml += `<td class="${cls}">${selContent}</td>`;
                }

                // Kolom Rekap Total
                rowHtml += `<td style="font-weight:bold;">${totH}</td><td>${totI}</td><td style="color:red;">${totA}</td>`;
                htmlBody += `<tr>${rowHtml}</tr>`;
            });

            tbody.innerHTML = htmlBody;
        }

        // === 4. FITUR DOWNLOAD EXCEL KHUSUS REKAP ===
        function downloadExcelRekap() {
            const table = document.getElementById("tabel-rekap");
            const kls = document.getElementById('pilih-kelas-rekap').value;
            const blnTxt = document.getElementById('pilih-bulan').options[document.getElementById('pilih-bulan').selectedIndex].text;
            
            if(table.rows.length < 3) { alert("Tampilkan data dulu baru download!"); return; }

            let html = table.outerHTML.replace(/ /g, '%20');
            html = html.replace(/<table/g, '<table border="1" style="font-family:Arial"'); // Tambah border buat Excel

            const link = document.createElement("a");
            link.href = 'data:application/vnd.ms-excel,' + html;
            link.download = `REKAP_ABSENSI_${kls}_${blnTxt}.xls`;
            link.click();
        }

        function logout(){ 
            if(confirm("Keluar?")) { localStorage.removeItem('userLoggedIn'); window.location.href='index.html'; } 
        }

        // Default Load
        loadDataHarian();
    </script>
</body>
</html>